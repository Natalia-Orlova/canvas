<!-- <!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <div id="reader" style="width: 600px; height: 600px;"></div>
    <div class="result"></div>
    <input type="text" id="result" style="display: none">
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
</body>
<script>
    // с возможностью загрузить картинку кода
    // function onScanSuccess(decodedText, decodedResult) {
    //     // handle the scanned code as you like, for example:
    //     // console.log(`Code matched = ${decodedText}`, decodedResult);
    //     const result = document.querySelector('.result');
    //     if (isReceipt(decodedText)) {
    //         result.textContent = decodedText;
    //     } else {
    //         result.textContent = `Этот qr-код не от чека: ${decodedText}`;
    //     }

    //     const resultInput = document.querySelector('#result');
    //     resultInput.value = decodedText;
    //     uploadText();
    // }

    // function onScanFailure(error) {
    //     // handle scan failure, usually better to ignore and keep scanning.
    //     // for example:
    //     console.warn(`Code scan error = ${error}`);
    // }

    // let html5QrcodeScanner = new Html5QrcodeScanner(
    //     "reader",
    //     { fps: 10, qrbox: { width: 500, height: 500 } },
    //   /* verbose= */ false);
    // html5QrcodeScanner.render(onScanSuccess, onScanFailure);



    



    

//     function onScanSuccess(decodedText, decodedResult) {
//     const result = document.querySelector('.result');
//     if (isReceipt(decodedText)) {
//         result.textContent = decodedText;
//     } else {
//         result.textContent = `Этот qr-код не от чека: ${decodedText}`;
//     }

//     const resultInput = document.querySelector('#result');
//     resultInput.value = decodedText;
//     uploadText();
// }

// function onScanFailure(error) {
//     console.warn(`Code scan error = ${error}`);
// }

// let html5QrcodeScanner = new Html5QrcodeScanner(
//     "reader",
//     { fps: 10, qrbox: { width: 500, height: 500 } },
//     /* verbose= */ false);

// // Функция для выбора задней камеры и установки разрешения
// function setupCamera() {
//     // Запрашиваем доступ к видеопотоку с камеры
//     navigator.mediaDevices.getUserMedia({ video: true })
//         .then(stream => {
//             // Если доступ предоставлен, продолжаем настройку камеры
//             Html5Qrcode.getCameras().then(devices => {
//                 if (devices && devices.length) {
//                     const backCamera = devices[0]; // Предполагаем, что первая камера - задняя
//                     alert(backCamera.id);
//                     html5QrcodeScanner.clear().then(() => {
//                         html5QrcodeScanner.start(
//                             backCamera.id,
//                             {
//                                 fps: 10,
//                                 qrbox: { width: 500, height: 500 },
//                                 // aspectRatio: 1.0 
//                             },
//                             onScanSuccess,
//                             onScanFailure
//                         );
//                     }).catch(error => {
//                         console.error("Failed to start camera:", error);
//                     });
//                 }
//             }).catch(err => {
//                 console.error("Error fetching camera devices:", err);
//             });
//         })
//         .catch(err => {
//             // Обрабатываем ошибку, если доступ к камере не предоставлен
//             console.error("Error accessing camera:", err);
//             alert("Не удалось получить доступ к камере. Пожалуйста, проверьте разрешения.");
//         });
// }

// // Инициализация сканера и настройка камеры
// setupCamera();






    // const html5QrCode = new Html5Qrcode("reader");
    // const qrCodeSuccessCallback = (decodedText, decodedResult) => {
    //     const result = document.querySelector('.result');
    //     result.textContent = decodedText;

    //     const resultInput = document.querySelector('#result');
    //     resultInput.value = decodedText;
    //     // uploadText();
    // };
    // const config = { fps: 10, qrbox: { width: 500, height: 500 } };

    // // If you want to prefer back camera
    // html5QrCode.start({ facingMode: "environment" }, config, qrCodeSuccessCallback);

    // // Select back camera or fail with `OverconstrainedError`.
    // html5QrCode.start({ facingMode: { exact: "environment" } }, config, qrCodeSuccessCallback);


    // html5QrCode.stop().then((ignore) => {
    //     // QR Code scanning is stopped.
    // }).catch((err) => {
    //     // Stop failed, handle it.
    // });


    function uploadText() {

        // Get the text data from the input field
        const textData = document.querySelector('#result').value;

        // Create a new XMLHttpRequest object
        const xhr = new XMLHttpRequest();

        // Set the HTTP method and the URL
        xhr.open("POST", "upload.php");

        // Set the responseType to text, so that xhr.response is a string
        xhr.responseType = "text";

        // Set the request header to send JSON data
        xhr.setRequestHeader("Content-Type", "application/json;charset=UTF-8");

        // Define the onload event handler
        xhr.onload = function () {
            if (xhr.status === 200) {
                // If the request is successful, display the server's response
                console.log(xhr.response);
            } else {
                // If the request is not successful, display the error
                console.log("Error: " + xhr.status);
            }
        };

        // Send the request with the text data
        xhr.send(JSON.stringify({ text: textData }));
    }


    // Функция для проверки, является ли содержимое чеком
    function isReceipt(content) {
        // Регулярное выражение для проверки формата чека
        const receiptPattern = /^t=\d{8}T\d{4}(\d{2})?&s=\d+(\.\d{2})?&fn=\d+&i=\d+&fp=\d+&n=\d+$/;
        return receiptPattern.test(content);
    }
</script>

</html> -->



<!DOCTYPE html>
<html>
<head>
    <title>Сканер QR и DataMatrix</title>
    <style>
        #reader {
            width: 600px;
            margin: 0 auto;
        }
        .scan-result {
            margin: 20px auto;
            padding: 15px;
            max-width: 600px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background-color: #f9f9f9;
        }
        .result-type {
            font-weight: bold;
            margin-bottom: 10px;
            padding: 5px;
            border-radius: 3px;
            color: white;
        }
        .receipt {
            background-color: #4CAF50;
        }
        .honest-sign {
            background-color: #2196F3;
        }
        .unknown {
            background-color: #f44336;
        }
        .result-data {
            word-wrap: break-word;
            font-family: monospace;
        }
        #startButton {
            display: block;
            margin: 20px auto;
            padding: 10px 20px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
        }
    </style>
</head>
<body>
    <div id="reader"></div>
    <button id="startButton">Начать сканирование</button>
    
    <div id="resultContainer" class="scan-result" style="display: none;">
        <div id="resultType" class="result-type"></div>
        <div>Тип кода: <span id="codeFormat"></span></div>
        <div>Содержимое:</div>
        <div id="resultData" class="result-data"></div>
    </div>

    <script src="https://unpkg.com/html5-qrcode@2.3.8/dist/html5-qrcode.min.js"></script>
    <script>
        let html5QrcodeScanner;
        const startButton = document.getElementById('startButton');
        const resultContainer = document.getElementById('resultContainer');
        const resultType = document.getElementById('resultType');
        const codeFormat = document.getElementById('codeFormat');
        const resultData = document.getElementById('resultData');

        startButton.addEventListener('click', startScanner);

        function startScanner() {
            // Остановить предыдущий сканер, если он был
            if (html5QrcodeScanner) {
                html5QrcodeScanner.clear().catch(error => {
                    console.error("Failed to clear html5QrcodeScanner. ", error);
                });
            }

            // Скрыть кнопку и показать сканер
            startButton.style.display = 'none';
            resultContainer.style.display = 'none';

            html5QrcodeScanner = new Html5QrcodeScanner(
                "reader",
                { 
                    fps: 10, 
                    qrbox: { width: 500, height: 500 },
                    supportedScanTypes: [Html5QrcodeScanType.SCAN_TYPE_CAMERA],
                    formatsToSupport: [
                        Html5QrcodeSupportedFormats.QR_CODE,
                        Html5QrcodeSupportedFormats.DATA_MATRIX
                    ]
                },
                false
            );

            html5QrcodeScanner.render(onScanSuccess, onScanFailure);
        }

        function onScanSuccess(decodedText, decodedResult) {
            // Остановить сканер после успешного сканирования
            html5QrcodeScanner.clear().catch(error => {
                console.error("Failed to clear html5QrcodeScanner. ", error);
            });

            // Показать кнопку и результаты
            startButton.style.display = 'block';
            resultContainer.style.display = 'block';

            // Определить тип кода
            let type, typeClass;
            if (isReceipt(decodedText)) {
                type = "QR-код чека";
                typeClass = "receipt";
            } else if (isHonestSign(decodedText)) {
                type = "Честный знак";
                typeClass = "honest-sign";
            } else {
                type = "Неизвестный код";
                typeClass = "unknown";
            }

            // Вывести результаты на страницу
            resultType.textContent = type;
            resultType.className = `result-type ${typeClass}`;
            codeFormat.textContent = decodedResult.result.format.formatName;
            resultData.textContent = decodedText;

            // Можно добавить дополнительную обработку данных
            if (type === "Честный знак") {
                parseHonestSign(decodedText);
            }
        }

        function onScanFailure(error) {
            console.warn(`Ошибка сканирования: ${error}`);
        }

        function isReceipt(code) {
            // Ваша существующая проверка для чеков
            return code.startsWith('t=') || code.includes('&fn=') || code.includes('&i=') || code.includes('&fp=');
        }

        function isHonestSign(code) {
            // Проверяем форматы кодов "Честного знака":
            // 1. DataMatrix (01...21...)
            if (/^01\d{14}21.+$/.test(code)) {
                return true;
            }
            
            // 2. QR с криптохвостами (t=, s=, sn=)
            if (code.includes('t=') && code.includes('s=') && code.includes('sn=')) {
                return true;
            }
            
            return false;
        }

        function parseHonestSign(code) {
            // Дополнительный парсинг для "Честного знака"
            if (/^01\d{14}21.+$/.test(code)) {
                // DataMatrix формат: 01<GTIN>21<serial>
                const gtin = code.substring(2, 16);
                const serial = code.substring(18);
                console.log("GTIN:", gtin);
                console.log("Serial:", serial);
            } else if (code.includes('t=')) {
                // QR с криптохвостами
                const params = new URLSearchParams(code.split('?')[1]);
                console.log("Криптохвост:", params.get('t'));
                console.log("Серийный номер:", params.get('sn'));
            }
        }
    </script>
</body>
</html>